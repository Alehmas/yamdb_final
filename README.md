#  YaMDb

##  Описание
Проект YaMDb собирает отзывы пользователей на произведения. Сами произведения в YaMDb не хранятся,
здесь нельзя посмотреть фильм или послушать музыку.
Произведения делятся на категории, а так же может быть присвоен жанр из списка предустановленных.
Добавлять произведения, категории и жанры может только администратор.
Благодарные или возмущённые пользователи оставляют к произведениям текстовые отзывы и ставят
произведению оценку в диапазоне от одного до десяти (целое число); из пользовательских оценок
формируется усреднённая оценка произведения — рейтинг. На одно произведение пользователь может
оставить только один отзыв.

###  Ресурсы API YaMDb
- Ресурс **auth**: аутентификация.
- Ресурс **users**: пользователи.
- Ресурс **titles**: произведения, к которым пишут отзывы (определённый фильм, книга или песенка).
- Ресурс **categories**: категории (типы) произведений («Фильмы», «Книги», «Музыка»).
- Ресурс **genres**: жанры произведений. Одно произведение может быть привязано к нескольким жанрам.
- Ресурс **reviews**: отзывы на произведения. Отзыв привязан к определённому произведению.
- Ресурс **comments**: комментарии к отзывам. Комментарий привязан к определённому отзыву.

### Пользовательские роли и права доступа
- **Аноним** — может просматривать описания произведений, читать отзывы и комментарии.
- **Аутентифицированный пользователь** (user) — может читать всё, как и Аноним, может публиковать отзывы
  и ставить оценки произведениям, может  комментировать отзывы; может редактировать
  и удалять свои отзывы и комментарии, редактировать свои оценки произведений. Эта роль присваивается
  по умолчанию каждому новому пользователю.
- **Модератор** (moderator) — те же права, что и у Аутентифицированного пользователя,
  плюс право удалять и редактировать любые отзывы и комментарии.
- **Администратор** (admin) — полные права на управление всем контентом проекта.
  Может создавать и удалять произведения, категории и жанры. Может назначать роли пользователям.
- **Суперюзер Django** обладает правами администратора, пользователя с правами admin.

## Подготовка и запуск проекта
### Клонирование репозитория
Склонируйте репозиторий на локальную машину:
```bash
git clone git@github.com:Oleg-2006/yamdb_final.git
```

### Установка на удаленном сервере (Ubuntu):
**Шаг 1** Выполните вход на свой удаленный сервер
Прежде, чем приступать к работе, необходимо выполнить вход на свой удаленный сервер:
```bash
ssh <USERNAME>@<IP_ADDRESS>
```

**Шаг 2** Установите docker на сервер:
Введите команду:
```bash
sudo apt install docker.io 
```

**Шаг 3** Установите docker-compose на сервер:
Введите команды:
```bash
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

**Шаг 4** Скопируйте подготовленные файлы:
Скопируйте подготовленные файлы `docker-compose.yaml` и `nginx/default.conf` из вашего проекта на сервер в `home/<ваш_username>/docker-compose.yaml` и `home/<ваш_username>/nginx/default.conf` соответственно.
Введите команду из корневой папки проекта:
```bash
scp docker-compose.yml <username>@<host>:/home/<username>/docker-compose.yml
scp -r nginx/ <username>@<host>:/home/<username>/
```

**Шаг 5** Добавьте Secrets:
Для работы с Workflow добавьте в Secrets GitHub переменные окружения для работы:
```bash
SECRET_KEY=<SECRET_KEY>  # предварительно изменив setting.py
DEBUG=<True/False>  # предварительно изменив setting.py
ALLOWED_HOSTS=<hosts>  # предварительно изменив setting.py
DB_ENGINE=django.db.backends.postgresql
DB_NAME=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
DB_HOST=db
DB_PORT=5432
DOCKER_PASSWORD=<пароль DockerHub>
DOCKER_USERNAME=<имя пользователя DockerHub>
USER=<username для подключения к серверу>
HOST=<IP сервера>
PASSPHRASE=<пароль для сервера, если он установлен>
SSH_KEY=<ваш SSH ключ (для получения команда: cat ~/.ssh/id_rsa)>
TELEGRAM_TO=<ID своего телеграм-аккаунта>
TELEGRAM_TOKEN=<токен вашего бота>
```

**Шаг 6** Для запуска workflow необходимо запушить проект:
```bash
git add .
git commit -m "свой комментарий"
git push
```
После пуша выполнятся все пункты описанные в `yamdb_workflow.yml`
**Workflow** состоит из четырёх шагов:
- **tests**
  Проверка кода на соответствие PEP8, автоматический запуск тестов.
- **build and push Docker image to Docker Hub**
  Сборка и публикация образа на DockerHub.
- **deploy** 
  Автоматический деплой на боевой сервер.
  Инструкции по развёртыванию проекта описана в файле `docker-compose.yaml`.
  Проект развертывается в трех контейнерах:
  - *db* контейнер базы данных через postgres:13.0-alpine
  - *web* контейнер Django-приложения
  - *nginx* контейнер который отвечает за раздачу статики
- **send_massage**
  Отправка уведомления в телеграм-чат.

**Шаг 7** После успешного деплоя:
Зайдите на боевой сервер и выполните команды (только после первого деплоя):
##### Создаем и применяем миграции:
```bash
sudo docker-compose exec web python manage.py makemigrations --noinput
sudo docker-compose exec web python manage.py migrate --noinput
```
##### Подгружаем статику
```bash
sudo docker-compose exec web python manage.py collectstatic --no-input 
```
##### Создать суперпользователя Django:
```bash
sudo docker-compose exec web python manage.py createsuperuser
```

**Шаг 8** Проект запущен
Проект будет доступен по вашему IP-адресу.

##  Используемые технологии
- проект написан на Python с использованием Django REST Framework
- базы данны PostgreSQL
- библиотека django-filter - фильтрация запросов
- библиотека PyJWT - работа с JWT-токеном
- тестирование кода проекта pytest
- автоматическое развертывание проекта GitHub Actions
- контейнеризация проекта
  - Docker
  - docker-compose
  - DockerHub
  - gunicorn
  - nginx

## Примеры запросов
Примеры запросов, права доступа, возожные ответы доступны в подключенной к проекту [документации](http://127.0.0.1:8000/redoc/)

## Авторы
- [Олег Маслов](https://github.com/Oleg-2006)
